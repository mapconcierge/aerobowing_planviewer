<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Éâ„É≠„Éº„É≥„Éï„É©„Ç§„Éà„Éó„É©„É≥Á∑®ÈõÜ„ÉÑ„Éº„É´</title>
    <script src='https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js'></script>
    <link href='https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css' rel='stylesheet' />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f0f2f5;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }

        .upload-panel {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            text-align: center;
            z-index: 1000;
            max-width: 500px;
            width: 90%;
        }

        .upload-panel.hidden {
            display: none;
        }

        .upload-panel h1 {
            font-size: 24px;
            margin-bottom: 10px;
            color: #333;
        }

        .upload-panel p {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .upload-area {
            border: 3px dashed #4CAF50;
            border-radius: 8px;
            padding: 40px 20px;
            cursor: pointer;
            transition: all 0.3s;
            background: #f8fdf9;
        }

        .upload-area:hover {
            border-color: #45a049;
            background: #f0fdf4;
        }

        .upload-area.dragover {
            border-color: #2196F3;
            background: #e3f2fd;
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .upload-text {
            font-size: 16px;
            color: #333;
            margin-bottom: 10px;
        }

        .upload-hint {
            font-size: 13px;
            color: #999;
        }

        #fileInput {
            display: none;
        }

        .info-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 320px;
            z-index: 1;
        }

        .info-panel h2 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 8px;
        }

        .info-item {
            margin-bottom: 12px;
            font-size: 14px;
        }

        .info-label {
            font-weight: bold;
            color: #555;
            display: inline-block;
            min-width: 100px;
        }

        .info-value {
            color: #333;
        }

        .edit-mode-toggle {
            margin: 15px 0;
            padding: 12px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            width: 100%;
            transition: background 0.3s;
            font-weight: bold;
        }

        .edit-mode-toggle:hover {
            background: #1976D2;
        }

        .edit-mode-toggle.active {
            background: #FF9800;
        }

        .edit-mode-toggle.active:hover {
            background: #F57C00;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .action-button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
            font-weight: 500;
        }

        .save-button {
            background: #4CAF50;
            color: white;
        }

        .save-button:hover {
            background: #45a049;
        }

        .reload-button {
            background: #757575;
            color: white;
        }

        .reload-button:hover {
            background: #616161;
        }

        .edit-hint {
            background: #fff3cd;
            color: #856404;
            padding: 12px;
            border-radius: 6px;
            font-size: 13px;
            margin-top: 15px;
            display: none;
        }

        .edit-hint.show {
            display: block;
        }

        .legend {
            position: absolute;
            bottom: 30px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1;
        }

        .legend h3 {
            font-size: 14px;
            margin-bottom: 10px;
            color: #333;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .legend-color {
            width: 20px;
            height: 3px;
            margin-right: 8px;
        }

        .legend-marker {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .maplibregl-popup-content {
            padding: 12px;
            border-radius: 6px;
        }

        .popup-title {
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
        }

        .popup-detail {
            font-size: 13px;
            margin: 4px 0;
            color: #666;
        }

        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 6px;
            margin-top: 20px;
            font-size: 14px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        .success-message {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
            font-size: 14px;
            display: none;
        }

        .success-message.show {
            display: block;
        }

        .draggable-marker {
            cursor: move;
        }

        .draggable-marker:hover {
            transform: scale(1.2);
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div class="upload-panel" id="uploadPanel">
        <h1>üìÅ „Éï„É©„Ç§„Éà„Éó„É©„É≥„ÇíË™≠„ÅøËæº„ÇÄ</h1>
        <p>.plan „Éï„Ç°„Ç§„É´„Çí„Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó„Åô„Çã„Åã„ÄÅ„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
        <div class="upload-area" id="uploadArea">
            <div class="upload-icon">üì§</div>
            <div class="upload-text">„Éï„Ç°„Ç§„É´„Çí„Éâ„É≠„ÉÉ„Éó</div>
            <div class="upload-hint">„Åæ„Åü„ÅØ„ÄÅ„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû</div>
        </div>
        <input type="file" id="fileInput" accept=".plan">
        <div class="error-message" id="errorMessage"></div>
    </div>
    
    <div class="info-panel" id="infoPanel" style="display: none;">
        <h2>üìä „Éï„É©„Ç§„ÉàÊÉÖÂ†±</h2>
        <div class="info-item">
            <span class="info-label">„Éï„Ç°„Ç§„É´Âêç:</span>
            <span class="info-value" id="fileName">-</span>
        </div>
        <div class="info-item">
            <span class="info-label">Á∑è„Ç¶„Çß„Ç§„Éù„Ç§„É≥„Éà:</span>
            <span class="info-value" id="totalWaypoints">-</span>
        </div>
        <div class="info-item">
            <span class="info-label">„Çµ„Éº„Éô„Ç§„Éù„Ç§„É≥„Éà:</span>
            <span class="info-value" id="surveyPoints">-</span>
        </div>
        <div class="info-item">
            <span class="info-label">ÊúÄÂ§ßÈ´òÂ∫¶:</span>
            <span class="info-value" id="maxAltitude">-</span>
        </div>
        <div class="info-item">
            <span class="info-label">Â∑°Ëà™ÈÄüÂ∫¶:</span>
            <span class="info-value" id="cruiseSpeed">-</span>
        </div>
        <div class="info-item">
            <span class="info-label">„Ç´„É°„É©„Ç∑„Éß„ÉÉ„Éà:</span>
            <span class="info-value" id="cameraShots">-</span>
        </div>
        
        <button class="edit-mode-toggle" id="editModeToggle" onclick="toggleEditMode()">
            ‚úèÔ∏è Á∑®ÈõÜ„É¢„Éº„Éâ ON
        </button>
        
        <div class="edit-hint" id="editHint">
            Á∑®ÈõÜ„É¢„Éº„Éâ: „Ç¶„Çß„Ç§„Éù„Ç§„É≥„Éà„Çí„Éâ„É©„ÉÉ„Ç∞„Åó„Å¶‰ΩçÁΩÆ„ÇíÂ§âÊõ¥„Åß„Åç„Åæ„Åô
        </div>
        
        <div class="button-group">
            <button class="action-button save-button" onclick="saveFlightPlan()">üíæ ‰øùÂ≠ò</button>
            <button class="action-button reload-button" onclick="reloadPage()">üîÑ Êñ∞Ë¶è</button>
        </div>
        
        <div class="success-message" id="successMessage"></div>
    </div>

    <div class="legend" id="legend" style="display: none;">
        <h3>Âá°‰æã</h3>
        <div class="legend-item">
            <div class="legend-color" style="background: #4CAF50;"></div>
            <span>È£õË°å„É´„Éº„Éà</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #2196F3;"></div>
            <span>„Çµ„Éº„Éô„Ç§„É´„Éº„Éà</span>
        </div>
        <div class="legend-item">
            <div class="legend-marker" style="background: #FF5722; border: 2px solid white;"></div>
            <span>Èõ¢Èô∏Âú∞ÁÇπ</span>
        </div>
        <div class="legend-item">
            <div class="legend-marker" style="background: #FFC107; border: 2px solid white;"></div>
            <span>„Ç¶„Çß„Ç§„Éù„Ç§„É≥„Éà</span>
        </div>
        <div class="legend-item">
            <div class="legend-marker" style="background: #9C27B0; border: 2px solid white;"></div>
            <span>ÁùÄÈô∏Âú∞ÁÇπ</span>
        </div>
    </div>

    <script>
        let map;
        let markers = [];
        let flightPlanData = null;
        let currentFileName = '';
        let editMode = false;
        let waypointMarkers = new Map(); // waypointIndex -> {marker, data}

        // MapLibre GL JS „Éû„ÉÉ„Éó„ÅÆÂàùÊúüÂåñ
        function initMap() {
            map = new maplibregl.Map({
                container: 'map',
                style: 'https://tile.openstreetmap.jp/styles/osm-bright-ja/style.json',
                center: [139.9742306, 35.9301209],
                zoom: 14,
                pitch: 45,
                bearing: 0
            });

            map.addControl(new maplibregl.NavigationControl(), 'top-left');
            map.addControl(new maplibregl.ScaleControl(), 'bottom-left');
        }

        // „Éï„Ç°„Ç§„É´„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„ÅÆË®≠ÂÆö
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const uploadPanel = document.getElementById('uploadPanel');
        const errorMessage = document.getElementById('errorMessage');

        uploadArea.addEventListener('click', () => fileInput.click());

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file) {
                handleFile(file);
            }
        });

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                handleFile(file);
            }
        });

        function handleFile(file) {
            if (!file.name.endsWith('.plan')) {
                showError('.plan „Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const flightPlan = JSON.parse(e.target.result);
                    flightPlanData = flightPlan;
                    currentFileName = file.name;
                    loadFlightPlan(flightPlan, file.name);
                    uploadPanel.classList.add('hidden');
                    document.getElementById('infoPanel').style.display = 'block';
                    document.getElementById('legend').style.display = 'block';
                } catch (error) {
                    showError('„Éï„Ç°„Ç§„É´„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.add('show');
            setTimeout(() => {
                errorMessage.classList.remove('show');
            }, 5000);
        }

        function showSuccess(message) {
            const successMessage = document.getElementById('successMessage');
            successMessage.textContent = message;
            successMessage.classList.add('show');
            setTimeout(() => {
                successMessage.classList.remove('show');
            }, 3000);
        }

        function toggleEditMode() {
            editMode = !editMode;
            const toggleBtn = document.getElementById('editModeToggle');
            const editHint = document.getElementById('editHint');
            
            if (editMode) {
                toggleBtn.textContent = 'üîí Á∑®ÈõÜ„É¢„Éº„Éâ OFF';
                toggleBtn.classList.add('active');
                editHint.classList.add('show');
                enableMarkerDragging();
            } else {
                toggleBtn.textContent = '‚úèÔ∏è Á∑®ÈõÜ„É¢„Éº„Éâ ON';
                toggleBtn.classList.remove('active');
                editHint.classList.remove('show');
                disableMarkerDragging();
            }
        }

        function enableMarkerDragging() {
            waypointMarkers.forEach((item, index) => {
                if (item.marker && item.data.command !== 530) { // VTOLËµ∑Âãï„Ç≥„Éû„É≥„Éâ‰ª•Â§ñ
                    item.marker.setDraggable(true);
                    item.marker.getElement().classList.add('draggable-marker');
                }
            });
        }

        function disableMarkerDragging() {
            waypointMarkers.forEach((item, index) => {
                if (item.marker) {
                    item.marker.setDraggable(false);
                    item.marker.getElement().classList.remove('draggable-marker');
                }
            });
        }

        function loadFlightPlan(flightPlan, fileName) {
            // „Éû„ÉÉ„Éó„Åå„Åæ„Å†Ë™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅØÂæÖÊ©ü
            if (!map.loaded()) {
                map.on('load', () => visualizeFlightPlan(flightPlan, fileName));
            } else {
                visualizeFlightPlan(flightPlan, fileName);
            }
        }

        function visualizeFlightPlan(flightPlan, fileName) {
            // Êó¢Â≠ò„ÅÆ„É¨„Ç§„É§„Éº„Å®„Éû„Éº„Ç´„Éº„Çí„ÇØ„É™„Ç¢
            clearMap();

            // „Ç¶„Çß„Ç§„Éù„Ç§„É≥„Éà„ÅÆÊäΩÂá∫
            const waypoints = [];
            const surveyPoints = [];
            let surveyItem = null;

            flightPlan.mission.items.forEach((item, index) => {
                if (item.type === 'SimpleItem' && item.params && item.params[4] && item.params[5]) {
                    waypoints.push({
                        lat: item.params[4],
                        lon: item.params[5],
                        alt: item.params[6] || 0,
                        command: item.command,
                        index: index,
                        itemIndex: index
                    });
                } else if (item.type === 'ComplexItem' && item.TransectStyleComplexItem) {
                    surveyItem = item;
                    const transect = item.TransectStyleComplexItem;
                    if (transect.VisualTransectPoints) {
                        transect.VisualTransectPoints.forEach(point => {
                            surveyPoints.push({
                                lat: point[0],
                                lon: point[1],
                                alt: transect.CameraCalc?.DistanceToSurface || 130
                            });
                        });
                    }
                }
            });

            // ÊÉÖÂ†±„Éë„Éç„É´„ÅÆÊõ¥Êñ∞
            document.getElementById('fileName').textContent = fileName;
            document.getElementById('totalWaypoints').textContent = waypoints.length;
            document.getElementById('surveyPoints').textContent = surveyPoints.length;
            document.getElementById('maxAltitude').textContent = 
                waypoints.length > 0 ? Math.max(...waypoints.map(w => w.alt)) + 'm' : '-';
            document.getElementById('cruiseSpeed').textContent = 
                flightPlan.mission.cruiseSpeed + 'm/s';
            document.getElementById('cameraShots').textContent = 
                surveyItem?.TransectStyleComplexItem?.CameraShots || 0;

            // Âú∞Âõ≥„ÅÆ‰∏≠ÂøÉ„ÇíË®≠ÂÆö
            if (flightPlan.mission.plannedHomePosition) {
                const homePos = flightPlan.mission.plannedHomePosition;
                map.flyTo({
                    center: [homePos[1], homePos[0]],
                    zoom: 14,
                    essential: true
                });
            }

            // „Éï„É©„Ç§„Éà„É´„Éº„Éà„ÅÆÊèèÁîª
            drawFlightRoute(waypoints);

            // „Çµ„Éº„Éô„Ç§„É´„Éº„Éà„ÅÆÊèèÁîª
            if (surveyPoints.length > 0) {
                drawSurveyRoute(surveyPoints, surveyItem);
            }

            // „Ç¶„Çß„Ç§„Éù„Ç§„É≥„Éà„Éû„Éº„Ç´„Éº„ÅÆËøΩÂä†
            waypoints.forEach((wp, index) => {
                addWaypointMarker(wp);
            });

            // „Éõ„Éº„É†„Éù„Ç∏„Ç∑„Éß„É≥„Éû„Éº„Ç´„Éº
            if (flightPlan.mission.plannedHomePosition) {
                const homePos = flightPlan.mission.plannedHomePosition;
                const homeEl = document.createElement('div');
                homeEl.innerHTML = 'üè†';
                homeEl.style.fontSize = '20px';
                homeEl.style.cursor = 'pointer';

                const homeMarker = new maplibregl.Marker(homeEl)
                    .setLngLat([homePos[1], homePos[0]])
                    .setPopup(new maplibregl.Popup().setHTML('<div class="popup-title">„Éõ„Éº„É†„Éù„Ç∏„Ç∑„Éß„É≥</div>'))
                    .addTo(map);

                markers.push(homeMarker);
            }
        }

        function drawFlightRoute(waypoints) {
            if (waypoints.length > 1) {
                const routeCoordinates = waypoints
                    .filter(w => w.command !== 530)
                    .map(w => [w.lon, w.lat]);

                if (routeCoordinates.length > 0) {
                    if (map.getSource('route')) {
                        map.getSource('route').setData({
                            type: 'Feature',
                            geometry: {
                                type: 'LineString',
                                coordinates: routeCoordinates
                            }
                        });
                    } else {
                        map.addSource('route', {
                            type: 'geojson',
                            data: {
                                type: 'Feature',
                                geometry: {
                                    type: 'LineString',
                                    coordinates: routeCoordinates
                                }
                            }
                        });

                        map.addLayer({
                            id: 'route',
                            type: 'line',
                            source: 'route',
                            paint: {
                                'line-color': '#4CAF50',
                                'line-width': 3,
                                'line-opacity': 0.8
                            }
                        });
                    }
                }
            }
        }

        function drawSurveyRoute(surveyPoints, surveyItem) {
            const surveyCoordinates = surveyPoints.map(p => [p.lon, p.lat]);
            
            map.addSource('survey-route', {
                type: 'geojson',
                data: {
                    type: 'Feature',
                    geometry: {
                        type: 'LineString',
                        coordinates: surveyCoordinates
                    }
                }
            });

            map.addLayer({
                id: 'survey-route',
                type: 'line',
                source: 'survey-route',
                paint: {
                    'line-color': '#2196F3',
                    'line-width': 2,
                    'line-opacity': 0.7,
                    'line-dasharray': [2, 2]
                }
            });

            // „Çµ„Éº„Éô„Ç§„Éù„É™„Ç¥„É≥„ÅÆÊèèÁîª
            if (surveyItem && surveyItem.polygon) {
                map.addSource('survey-polygon', {
                    type: 'geojson',
                    data: {
                        type: 'Feature',
                        geometry: {
                            type: 'Polygon',
                            coordinates: [surveyItem.polygon.map(p => [p[1], p[0]])]
                        }
                    }
                });

                map.addLayer({
                    id: 'survey-polygon',
                    type: 'fill',
                    source: 'survey-polygon',
                    paint: {
                        'fill-color': '#2196F3',
                        'fill-opacity': 0.1
                    }
                });

                map.addLayer({
                    id: 'survey-polygon-outline',
                    type: 'line',
                    source: 'survey-polygon',
                    paint: {
                        'line-color': '#2196F3',
                        'line-width': 2,
                        'line-opacity': 0.5
                    }
                });
            }
        }

        function addWaypointMarker(wp) {
            let color = '#FFC107';
            let label = `WP${wp.index}`;
            
            if (wp.command === 84) {
                color = '#FF5722';
                label = 'Èõ¢Èô∏';
            } else if (wp.command === 85) {
                color = '#9C27B0';
                label = 'ÁùÄÈô∏';
            } else if (wp.command === 530) {
                return; // VTOLËµ∑Âãï„Ç≥„Éû„É≥„Éâ„ÅØ„Éû„Éº„Ç´„Éº„ÇíË°®Á§∫„Åó„Å™„ÅÑ
            }

            const el = document.createElement('div');
            el.style.width = '12px';
            el.style.height = '12px';
            el.style.borderRadius = '50%';
            el.style.backgroundColor = color;
            el.style.border = '2px solid white';
            el.style.boxShadow = '0 2px 4px rgba(0,0,0,0.3)';
            el.style.cursor = 'pointer';

            const popup = new maplibregl.Popup({ offset: 15 })
                .setHTML(`
                    <div class="popup-title">${label}</div>
                    <div class="popup-detail">Á∑ØÂ∫¶: ${wp.lat.toFixed(6)}</div>
                    <div class="popup-detail">ÁµåÂ∫¶: ${wp.lon.toFixed(6)}</div>
                    <div class="popup-detail">È´òÂ∫¶: ${wp.alt}m</div>
                `);

            const marker = new maplibregl.Marker(el, { draggable: false })
                .setLngLat([wp.lon, wp.lat])
                .setPopup(popup)
                .addTo(map);

            // „Éâ„É©„ÉÉ„Ç∞„Ç§„Éô„É≥„Éà„ÅÆË®≠ÂÆö
            marker.on('dragend', () => {
                const lngLat = marker.getLngLat();
                updateWaypointPosition(wp.itemIndex, lngLat.lat, lngLat.lng);
                updateRouteDisplay();
                
                // „Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÅÆÊõ¥Êñ∞
                popup.setHTML(`
                    <div class="popup-title">${label}</div>
                    <div class="popup-detail">Á∑ØÂ∫¶: ${lngLat.lat.toFixed(6)}</div>
                    <div class="popup-detail">ÁµåÂ∫¶: ${lngLat.lng.toFixed(6)}</div>
                    <div class="popup-detail">È´òÂ∫¶: ${wp.alt}m</div>
                `);
            });

            markers.push(marker);
            waypointMarkers.set(wp.itemIndex, { marker, data: wp });
        }

        function updateWaypointPosition(itemIndex, newLat, newLon) {
            if (flightPlanData && flightPlanData.mission.items[itemIndex]) {
                const item = flightPlanData.mission.items[itemIndex];
                if (item.params && item.params.length >= 6) {
                    item.params[4] = newLat;
                    item.params[5] = newLon;
                }
            }
        }

        function updateRouteDisplay() {
            const waypoints = [];
            flightPlanData.mission.items.forEach((item, index) => {
                if (item.type === 'SimpleItem' && item.params && item.params[4] && item.params[5]) {
                    waypoints.push({
                        lat: item.params[4],
                        lon: item.params[5],
                        command: item.command
                    });
                }
            });
            drawFlightRoute(waypoints);
        }

        function saveFlightPlan() {
            if (!flightPlanData) {
                showError('„Éï„É©„Ç§„Éà„Éó„É©„É≥„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
                return;
            }

            const dataStr = JSON.stringify(flightPlanData, null, 4);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = currentFileName.replace('.plan', '_edited.plan');
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showSuccess('„Éï„Ç°„Ç§„É´„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü: ' + a.download);
        }

        function clearMap() {
            // „Éû„Éº„Ç´„Éº„ÅÆÂâäÈô§
            markers.forEach(marker => marker.remove());
            markers = [];
            waypointMarkers.clear();

            // „É¨„Ç§„É§„Éº„Å®„ÇΩ„Éº„Çπ„ÅÆÂâäÈô§
            const layersToRemove = ['route', 'survey-route', 'survey-polygon', 'survey-polygon-outline'];
            layersToRemove.forEach(layerId => {
                if (map.getLayer(layerId)) {
                    map.removeLayer(layerId);
                }
            });

            const sourcesToRemove = ['route', 'survey-route', 'survey-polygon'];
            sourcesToRemove.forEach(sourceId => {
                if (map.getSource(sourceId)) {
                    map.removeSource(sourceId);
                }
            });
        }

        function reloadPage() {
            location.reload();
        }

        // ÂàùÊúüÂåñ
        initMap();
    </script>
</body>
</html>