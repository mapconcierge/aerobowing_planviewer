<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ‰ãƒ­ãƒ¼ãƒ³ãƒ•ãƒ©ã‚¤ãƒˆãƒ—ãƒ©ãƒ³å¯è¦–åŒ–</title>
    <script src='https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js'></script>
    <link href='https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css' rel='stylesheet' />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f0f2f5;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }

        .upload-panel {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            text-align: center;
            z-index: 1000;
            max-width: 500px;
            width: 90%;
        }

        .upload-panel.hidden {
            display: none;
        }

        .upload-panel h1 {
            font-size: 24px;
            margin-bottom: 10px;
            color: #333;
        }

        .upload-panel p {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .upload-area {
            border: 3px dashed #4CAF50;
            border-radius: 8px;
            padding: 40px 20px;
            cursor: pointer;
            transition: all 0.3s;
            background: #f8fdf9;
        }

        .upload-area:hover {
            border-color: #45a049;
            background: #f0fdf4;
        }

        .upload-area.dragover {
            border-color: #2196F3;
            background: #e3f2fd;
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .upload-text {
            font-size: 16px;
            color: #333;
            margin-bottom: 10px;
        }

        .upload-hint {
            font-size: 13px;
            color: #999;
        }

        #fileInput {
            display: none;
        }

        .info-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 300px;
            z-index: 1;
        }

        .info-panel h2 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 8px;
        }

        .info-item {
            margin-bottom: 12px;
            font-size: 14px;
        }

        .info-label {
            font-weight: bold;
            color: #555;
            display: inline-block;
            min-width: 100px;
        }

        .info-value {
            color: #333;
        }

        .reload-button {
            margin-top: 15px;
            padding: 10px 20px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            width: 100%;
            transition: background 0.3s;
        }

        .reload-button:hover {
            background: #45a049;
        }

        .legend {
            position: absolute;
            bottom: 30px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1;
        }

        .legend h3 {
            font-size: 14px;
            margin-bottom: 10px;
            color: #333;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .legend-color {
            width: 20px;
            height: 3px;
            margin-right: 8px;
        }

        .legend-marker {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .maplibregl-popup-content {
            padding: 12px;
            border-radius: 6px;
        }

        .popup-title {
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
        }

        .popup-detail {
            font-size: 13px;
            margin: 4px 0;
            color: #666;
        }

        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 6px;
            margin-top: 20px;
            font-size: 14px;
            display: none;
        }

        .error-message.show {
            display: block;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div class="upload-panel" id="uploadPanel">
        <h1>ğŸ“ ãƒ•ãƒ©ã‚¤ãƒˆãƒ—ãƒ©ãƒ³ã‚’èª­ã¿è¾¼ã‚€</h1>
        <p>.plan ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã™ã‚‹ã‹ã€ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠã—ã¦ãã ã•ã„</p>
        <div class="upload-area" id="uploadArea">
            <div class="upload-icon">ğŸ“¤</div>
            <div class="upload-text">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ­ãƒƒãƒ—</div>
            <div class="upload-hint">ã¾ãŸã¯ã€ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</div>
        </div>
        <input type="file" id="fileInput" accept=".plan">
        <div class="error-message" id="errorMessage"></div>
    </div>
    
    <div class="info-panel" id="infoPanel" style="display: none;">
        <h2>ğŸ“Š ãƒ•ãƒ©ã‚¤ãƒˆæƒ…å ±</h2>
        <div class="info-item">
            <span class="info-label">ãƒ•ã‚¡ã‚¤ãƒ«å:</span>
            <span class="info-value" id="fileName">-</span>
        </div>
        <div class="info-item">
            <span class="info-label">ç·ã‚¦ã‚§ã‚¤ãƒã‚¤ãƒ³ãƒˆ:</span>
            <span class="info-value" id="totalWaypoints">-</span>
        </div>
        <div class="info-item">
            <span class="info-label">ã‚µãƒ¼ãƒ™ã‚¤ãƒã‚¤ãƒ³ãƒˆ:</span>
            <span class="info-value" id="surveyPoints">-</span>
        </div>
        <div class="info-item">
            <span class="info-label">æœ€å¤§é«˜åº¦:</span>
            <span class="info-value" id="maxAltitude">-</span>
        </div>
        <div class="info-item">
            <span class="info-label">å·¡èˆªé€Ÿåº¦:</span>
            <span class="info-value" id="cruiseSpeed">-</span>
        </div>
        <div class="info-item">
            <span class="info-label">ã‚«ãƒ¡ãƒ©ã‚·ãƒ§ãƒƒãƒˆ:</span>
            <span class="info-value" id="cameraShots">-</span>
        </div>
        <button class="reload-button" onclick="reloadPage()">åˆ¥ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€</button>
    </div>

    <div class="legend" id="legend" style="display: none;">
        <h3>å‡¡ä¾‹</h3>
        <div class="legend-item">
            <div class="legend-color" style="background: #4CAF50;"></div>
            <span>é£›è¡Œãƒ«ãƒ¼ãƒˆ</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #2196F3;"></div>
            <span>ã‚µãƒ¼ãƒ™ã‚¤ãƒ«ãƒ¼ãƒˆ</span>
        </div>
        <div class="legend-item">
            <div class="legend-marker" style="background: #FF5722; border: 2px solid white;"></div>
            <span>é›¢é™¸åœ°ç‚¹</span>
        </div>
        <div class="legend-item">
            <div class="legend-marker" style="background: #FFC107; border: 2px solid white;"></div>
            <span>ã‚¦ã‚§ã‚¤ãƒã‚¤ãƒ³ãƒˆ</span>
        </div>
        <div class="legend-item">
            <div class="legend-marker" style="background: #9C27B0; border: 2px solid white;"></div>
            <span>ç€é™¸åœ°ç‚¹</span>
        </div>
    </div>

    <script>
        let map;
        let markers = [];

        // MapLibre GL JS ãƒãƒƒãƒ—ã®åˆæœŸåŒ–
        function initMap() {
            map = new maplibregl.Map({
                container: 'map',
                style: 'https://tile.openstreetmap.jp/styles/osm-bright-ja/style.json',
                center: [139.9742306, 35.9301209],
                zoom: 14,
                pitch: 45,
                bearing: 0
            });

            map.addControl(new maplibregl.NavigationControl(), 'top-left');
            map.addControl(new maplibregl.ScaleControl(), 'bottom-left');
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã®è¨­å®š
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const uploadPanel = document.getElementById('uploadPanel');
        const errorMessage = document.getElementById('errorMessage');

        uploadArea.addEventListener('click', () => fileInput.click());

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file) {
                handleFile(file);
            }
        });

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                handleFile(file);
            }
        });

        function handleFile(file) {
            if (!file.name.endsWith('.plan')) {
                showError('.plan ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const flightPlan = JSON.parse(e.target.result);
                    loadFlightPlan(flightPlan, file.name);
                    uploadPanel.classList.add('hidden');
                    document.getElementById('infoPanel').style.display = 'block';
                    document.getElementById('legend').style.display = 'block';
                } catch (error) {
                    showError('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.add('show');
            setTimeout(() => {
                errorMessage.classList.remove('show');
            }, 5000);
        }

        function loadFlightPlan(flightPlan, fileName) {
            // ãƒãƒƒãƒ—ãŒã¾ã èª­ã¿è¾¼ã¾ã‚Œã¦ã„ãªã„å ´åˆã¯å¾…æ©Ÿ
            if (!map.loaded()) {
                map.on('load', () => visualizeFlightPlan(flightPlan, fileName));
            } else {
                visualizeFlightPlan(flightPlan, fileName);
            }
        }

        function visualizeFlightPlan(flightPlan, fileName) {
            // æ—¢å­˜ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨ãƒãƒ¼ã‚«ãƒ¼ã‚’ã‚¯ãƒªã‚¢
            clearMap();

            // ã‚¦ã‚§ã‚¤ãƒã‚¤ãƒ³ãƒˆã®æŠ½å‡º
            const waypoints = [];
            const surveyPoints = [];
            let surveyItem = null;

            flightPlan.mission.items.forEach((item, index) => {
                if (item.type === 'SimpleItem' && item.params && item.params[4] && item.params[5]) {
                    waypoints.push({
                        lat: item.params[4],
                        lon: item.params[5],
                        alt: item.params[6] || 0,
                        command: item.command,
                        index: index
                    });
                } else if (item.type === 'ComplexItem' && item.TransectStyleComplexItem) {
                    surveyItem = item;
                    const transect = item.TransectStyleComplexItem;
                    if (transect.VisualTransectPoints) {
                        transect.VisualTransectPoints.forEach(point => {
                            surveyPoints.push({
                                lat: point[0],
                                lon: point[1],
                                alt: transect.CameraCalc?.DistanceToSurface || 130
                            });
                        });
                    }
                }
            });

            // æƒ…å ±ãƒ‘ãƒãƒ«ã®æ›´æ–°
            document.getElementById('fileName').textContent = fileName;
            document.getElementById('totalWaypoints').textContent = waypoints.length;
            document.getElementById('surveyPoints').textContent = surveyPoints.length;
            document.getElementById('maxAltitude').textContent = 
                waypoints.length > 0 ? Math.max(...waypoints.map(w => w.alt)) + 'm' : '-';
            document.getElementById('cruiseSpeed').textContent = 
                flightPlan.mission.cruiseSpeed + 'm/s';
            document.getElementById('cameraShots').textContent = 
                surveyItem?.TransectStyleComplexItem?.CameraShots || 0;

            // åœ°å›³ã®ä¸­å¿ƒã‚’è¨­å®š
            if (flightPlan.mission.plannedHomePosition) {
                const homePos = flightPlan.mission.plannedHomePosition;
                map.flyTo({
                    center: [homePos[1], homePos[0]],
                    zoom: 14,
                    essential: true
                });
            }

            // ãƒ•ãƒ©ã‚¤ãƒˆãƒ«ãƒ¼ãƒˆã®æç”»
            if (waypoints.length > 1) {
                const routeCoordinates = waypoints
                    .filter(w => w.command !== 530)
                    .map(w => [w.lon, w.lat]);

                if (routeCoordinates.length > 0) {
                    map.addSource('route', {
                        type: 'geojson',
                        data: {
                            type: 'Feature',
                            geometry: {
                                type: 'LineString',
                                coordinates: routeCoordinates
                            }
                        }
                    });

                    map.addLayer({
                        id: 'route',
                        type: 'line',
                        source: 'route',
                        paint: {
                            'line-color': '#4CAF50',
                            'line-width': 3,
                            'line-opacity': 0.8
                        }
                    });
                }
            }

            // ã‚µãƒ¼ãƒ™ã‚¤ãƒ«ãƒ¼ãƒˆã®æç”»
            if (surveyPoints.length > 0) {
                const surveyCoordinates = surveyPoints.map(p => [p.lon, p.lat]);
                
                map.addSource('survey-route', {
                    type: 'geojson',
                    data: {
                        type: 'Feature',
                        geometry: {
                            type: 'LineString',
                            coordinates: surveyCoordinates
                        }
                    }
                });

                map.addLayer({
                    id: 'survey-route',
                    type: 'line',
                    source: 'survey-route',
                    paint: {
                        'line-color': '#2196F3',
                        'line-width': 2,
                        'line-opacity': 0.7,
                        'line-dasharray': [2, 2]
                    }
                });

                // ã‚µãƒ¼ãƒ™ã‚¤ãƒãƒªã‚´ãƒ³ã®æç”»
                if (surveyItem && surveyItem.polygon) {
                    map.addSource('survey-polygon', {
                        type: 'geojson',
                        data: {
                            type: 'Feature',
                            geometry: {
                                type: 'Polygon',
                                coordinates: [surveyItem.polygon.map(p => [p[1], p[0]])]
                            }
                        }
                    });

                    map.addLayer({
                        id: 'survey-polygon',
                        type: 'fill',
                        source: 'survey-polygon',
                        paint: {
                            'fill-color': '#2196F3',
                            'fill-opacity': 0.1
                        }
                    });

                    map.addLayer({
                        id: 'survey-polygon-outline',
                        type: 'line',
                        source: 'survey-polygon',
                        paint: {
                            'line-color': '#2196F3',
                            'line-width': 2,
                            'line-opacity': 0.5
                        }
                    });
                }
            }

            // ã‚¦ã‚§ã‚¤ãƒã‚¤ãƒ³ãƒˆãƒãƒ¼ã‚«ãƒ¼ã®è¿½åŠ 
            waypoints.forEach((wp, index) => {
                let color = '#FFC107';
                let label = `WP${index}`;
                
                if (wp.command === 84) {
                    color = '#FF5722';
                    label = 'é›¢é™¸';
                } else if (wp.command === 85) {
                    color = '#9C27B0';
                    label = 'ç€é™¸';
                }

                const el = document.createElement('div');
                el.style.width = '12px';
                el.style.height = '12px';
                el.style.borderRadius = '50%';
                el.style.backgroundColor = color;
                el.style.border = '2px solid white';
                el.style.boxShadow = '0 2px 4px rgba(0,0,0,0.3)';
                el.style.cursor = 'pointer';

                const popup = new maplibregl.Popup({ offset: 15 })
                    .setHTML(`
                        <div class="popup-title">${label}</div>
                        <div class="popup-detail">ç·¯åº¦: ${wp.lat.toFixed(6)}</div>
                        <div class="popup-detail">çµŒåº¦: ${wp.lon.toFixed(6)}</div>
                        <div class="popup-detail">é«˜åº¦: ${wp.alt}m</div>
                    `);

                const marker = new maplibregl.Marker(el)
                    .setLngLat([wp.lon, wp.lat])
                    .setPopup(popup)
                    .addTo(map);

                markers.push(marker);
            });

            // ãƒ›ãƒ¼ãƒ ãƒã‚¸ã‚·ãƒ§ãƒ³ãƒãƒ¼ã‚«ãƒ¼
            if (flightPlan.mission.plannedHomePosition) {
                const homePos = flightPlan.mission.plannedHomePosition;
                const homeEl = document.createElement('div');
                homeEl.innerHTML = 'ğŸ ';
                homeEl.style.fontSize = '20px';
                homeEl.style.cursor = 'pointer';

                const homeMarker = new maplibregl.Marker(homeEl)
                    .setLngLat([homePos[1], homePos[0]])
                    .setPopup(new maplibregl.Popup().setHTML('<div class="popup-title">ãƒ›ãƒ¼ãƒ ãƒã‚¸ã‚·ãƒ§ãƒ³</div>'))
                    .addTo(map);

                markers.push(homeMarker);
            }
        }

        function clearMap() {
            // ãƒãƒ¼ã‚«ãƒ¼ã®å‰Šé™¤
            markers.forEach(marker => marker.remove());
            markers = [];

            // ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨ã‚½ãƒ¼ã‚¹ã®å‰Šé™¤
            const layersToRemove = ['route', 'survey-route', 'survey-polygon', 'survey-polygon-outline'];
            layersToRemove.forEach(layerId => {
                if (map.getLayer(layerId)) {
                    map.removeLayer(layerId);
                }
            });

            const sourcesToRemove = ['route', 'survey-route', 'survey-polygon'];
            sourcesToRemove.forEach(sourceId => {
                if (map.getSource(sourceId)) {
                    map.removeSource(sourceId);
                }
            });
        }

        function reloadPage() {
            location.reload();
        }

        // åˆæœŸåŒ–
        initMap();
    </script>
</body>
</html>